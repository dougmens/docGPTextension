<html>
<head>
<base target="_top">
<style>
body {
font-family: Arial, sans-serif;
margin: 12px;
padding: 0;
font-size: 14px;
}
h2 {
margin-top: 0;
font-size: 18px;
}
.container {
display: flex;
flex-direction: column;
height: calc(100vh - 24px);
}
.settings {
margin-bottom: 12px;
}
select, button {
padding: 6px 10px;
margin: 4px 0;
font-size: 14px;
}
#contextWarning {
color: #c5221f;
font-size: 12px;
margin: 4px 0;
display: none;
}
#chatContainer {
flex: 1;
overflow-y: auto;
border: 1px solid #ddd;
padding: 10px;
margin-bottom: 10px;
background: #f9f9f9;
border-radius: 4px;
}
.message {
margin: 8px 0;
padding: 8px 12px;
border-radius: 6px;
max-width: 92%;
}
.user {
background: #e8f0fe;
align-self: flex-end;
margin-left: auto;
}
.assistant {
background: #ffffff;
border: 1px solid #e0e0e0;
}
#inputArea {
display: flex;
flex-direction: column;
}
#messageInput {
resize: vertical;
min-height: 60px;
padding: 8px;
font-size: 14px;
margin-bottom: 8px;
}
#controls {
display: flex;
flex-wrap: wrap;
gap: 8px;
}
#charCount {
font-size: 12px;
color: #555;
margin-top: 4px;
}
.action-btn {
padding: 6px 12px;
font-size: 13px;
cursor: pointer;
}
#loading {
display: none;
color: #1a73e8;
font-style: italic;
margin: 8px 0;
}
.error {
color: #c5221f;
padding: 8px;
background: #fcecec;
border-radius: 4px;
margin: 8px 0;
}
</style>
</head>
<body>
<div class="container">
<h2>ChatGPT Sidebar</h2>
      
        Modus:

        <select id="modeSelect">
          <option value="Allgemein">Allgemein</option>
          <option value="Schriftsatz">Schriftsatz (DE, juristisch)</option>
          <option value="Überarbeiten">Überarbeiten (klar/knapp)</option>
        </select>



Kontext:

<select id="contextSelect" onchange="updateContextWarning()">
          <option value="Nur Chat">Nur Chat</option>
          <option value="Mit Markierung">Mit Markierung</option>
          <option value="Mit ganzem Dokument">Mit ganzem Dokument</option>
        
        Achtung: Das gesamte Dokument wird an ChatGPT gesendet!
      
      
      
        <textarea id="messageInput" placeholder="Ihre Nachricht an ChatGPT..."></textarea>
        
          <button onclick="sendMessage()">Senden</button>
          <button class="action-btn" onclick="applyAction(&#x27;insert&#x27;)">An Cursor einfügen</button>
          <button class="action-btn" onclick="applyAction(&#x27;replace&#x27;)">Markierung ersetzen</button>
        
        
        Verarbeite...
        
      
    
    <script>
      let currentResponse = '';
      let lastCharCount = 0;
      let lastTruncated = false;

      function updateContextWarning() {
        const ctx = document.getElementById('contextSelect').value;
        document.getElementById('contextWarning').style.display = 
          (ctx === 'Mit ganzem Dokument') ? 'block' : 'none';
      }

      function addMessage(role, content) {
        const container = document.getElementById('chatContainer');
        const msg = document.createElement('div');
        msg.className = `message ${role}`;
        msg.textContent = content;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
      }

      function showError(message) {
        const errDiv = document.getElementById('error');
        errDiv.textContent = message;
        errDiv.style.display = 'block';
      }

      function clearError() {
        const errDiv = document.getElementById('error');
        errDiv.textContent = '';
        errDiv.style.display = 'none';
      }

      function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        addMessage('user', message);
        input.value = '';

        const mode = document.getElementById('modeSelect').value;
        const contextMode = document.getElementById('contextSelect').value;

        document.getElementById('loading').style.display = 'block';
        document.getElementById('charCount').textContent = 'Wird berechnet...';
        clearError();

        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .processChatRequest({
            message: message,
            mode: mode,
            contextMode: contextMode
          });
      }

      function onSuccess(result) {
        document.getElementById('loading').style.display = 'none';

        if (result.success) {
          currentResponse = result.answer;
          addMessage('assistant', result.answer);

          lastCharCount = result.charCount;
          lastTruncated = result.truncated;

          let info = `Gesendete Zeichen: ${lastCharCount}`;
          if (lastTruncated) {
            info += ' (Kontext wurde gekürzt)';
          }
          document.getElementById('charCount').textContent = info;
        } else {
          showError(result.error || 'Unbekannter Fehler');
        }
      }

      function onFailure(error) {
        document.getElementById('loading').style.display = 'none';
        showError(error.message || 'Verbindungsfehler');
      }

      function applyAction(type) {
        if (!currentResponse) {
          showError('Keine Antwort zum Einfügen vorhanden.');
          return;
        }

        let serverFunction;
        if (type === 'insert') {
          serverFunction = 'insertAtCursor';
        } else if (type === 'replace') {
          serverFunction = 'replaceSelection';
        } else {
          return;
        }

        if (type === 'replace') {
          const selection = true; // dummy – Prüfung erfolgt serverseitig
        }

        google.script.run
          .withSuccessHandler(() => {
            alert('Änderung erfolgreich angewendet.');
          })
          .withFailureHandler((err) => {
            showError(err.message || 'Fehler beim Anwenden der Änderung');
          })
          [serverFunction](currentResponse);
      }

      // Initialisierung
      updateContextWarning();
    </script>